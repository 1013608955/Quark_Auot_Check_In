name: Quarkç­¾åˆ°

on:
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00 (UTC+8)
    - cron: '0 5 * * *'   # åŒ—äº¬æ—¶é—´ 13:00 (UTC+8)
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:  # å…³é”®ï¼šæ·»åŠ å¿…è¦æƒé™
  actions: write  # æˆäºˆæ›´æ–°å˜é‡çš„æƒé™
  contents: read   # æˆäºˆè¯»å–ä»£ç çš„æƒé™

jobs:
  check-if-already-signed:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: åˆ¤æ–­æ˜¯å¦å·²ç­¾åˆ°ï¼ˆè¯»å–ä»“åº“å˜é‡ï¼‰
        id: check
        run: |
          # è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆæ ¼å¼ï¼š2026-01-02ï¼‰
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $current_date"
          
          # è¯»å–ä»“åº“å˜é‡ä¸­å­˜å‚¨çš„ä¸Šæ¬¡ç­¾åˆ°æ—¥æœŸï¼ˆæ— åˆ™ä¸ºç©ºï¼‰
          last_success_date="${{ vars.LAST_SUCCESS_DATE || '' }}"
          echo "ä¸Šæ¬¡ç­¾åˆ°æ—¥æœŸ: $last_success_date"
          
          # åˆ¤æ–­æ˜¯å¦å·²ç­¾åˆ°
          if [ "$last_success_date" = "$current_date" ]; then
            echo "âœ… ä»Šå¤©å·²æˆåŠŸç­¾åˆ°ï¼Œè·³è¿‡æ‰§è¡Œ"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "ğŸ”„ ä»Šå¤©å°šæœªç­¾åˆ°ï¼Œç»§ç»­æ‰§è¡Œ"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  sign-in:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: éšæœºå»¶è¿Ÿï¼ˆæ—©ä¸Šï¼‰
        if: github.event.schedule == '0 1 * * *'
        run: |
          delay=$((RANDOM % 60))
          echo "æ—©ä¸Šç­¾åˆ°ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: éšæœºå»¶è¿Ÿï¼ˆä¸‹åˆ/æ‰‹åŠ¨è§¦å‘ï¼‰
        if: github.event.schedule == '0 5 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          delay=$((RANDOM % 30))
          echo "ä¸‹åˆå…œåº•æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬
        id: sign_script  # å‘½åæ­¥éª¤ï¼Œç”¨äºè¯»å–è¾“å‡º
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
          WPUSH_KEY: ${{ secrets.WPUSH_KEY }}
        run: python checkIn_Quark.py

      - name: æ ‡è®°ä»Šå¤©ç­¾åˆ°æˆåŠŸï¼ˆä¿®å¤APIè°ƒç”¨ï¼‰
        if: steps.sign_script.outputs.overall_success == 'true'
        run: |
          # ç”ŸæˆåŒ—äº¬æ—¶é—´æ ¼å¼çš„æ—¥æœŸï¼ˆ2026-01-02ï¼‰
          CURRENT_DATE=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          # æ‹†åˆ†ä»“åº“æ‰€æœ‰è€…å’Œä»“åº“åï¼ˆæ›´å¯é çš„æ–¹å¼ï¼‰
          REPO_FULL="${{ github.repository }}"  # æ ¼å¼ï¼šowner/repo
          OWNER=$(echo "$REPO_FULL" | cut -d '/' -f 1)
          REPO=$(echo "$REPO_FULL" | cut -d '/' -f 2)
          # GitHub Token
          TOKEN="${{ secrets.GITHUB_TOKEN }}"
          
          echo "ğŸ“Œ è°ƒè¯•ä¿¡æ¯ï¼šOWNER=$OWNER, REPO=$REPO, DATE=$CURRENT_DATE"
          
          # è°ƒç”¨GitHub REST APIåˆ›å»º/æ›´æ–°å˜é‡ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
          RESPONSE=$(curl -s -w "%{http_code}" -L -X PUT \
            "https://api.github.com/repos/$OWNER/$REPO/actions/variables/LAST_SUCCESS_DATE" \
            -H "Authorization: token $TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"name\":\"LAST_SUCCESS_DATE\",\"value\":\"$CURRENT_DATE\"}")
          
          # æ‰“å°å“åº”ä¿¡æ¯ï¼Œæ–¹ä¾¿è°ƒè¯•
          echo "ğŸ” APIå“åº”ï¼š$RESPONSE"
          
          # æ£€æŸ¥HTTPçŠ¶æ€ç 
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "204" ]; then
            echo "âœ… å·²æˆåŠŸæ›´æ–°ä»“åº“å˜é‡ LAST_SUCCESS_DATE = $CURRENT_DATE"
          else
            echo "âŒ æ›´æ–°å˜é‡å¤±è´¥ï¼çŠ¶æ€ç ï¼š$HTTP_CODEï¼Œå“åº”ä½“ï¼š$BODY"
            exit 1  # æ ‡è®°æ­¥éª¤å¤±è´¥
          fi

      - name: æ¸…ç†æ—§çš„å·¥ä½œæµè®°å½•
        uses: Mattraks/delete-workflow-runs@main
        if: always()
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 60
