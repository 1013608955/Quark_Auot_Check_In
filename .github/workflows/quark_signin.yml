name: Quarkç­¾åˆ° (ä¼˜åŒ–ç‰ˆ)

on:
  schedule:
    - cron: '0 1 * * *'   # åŒ—äº¬æ—¶é—´ 09:00 (UTC+8)
    - cron: '0 5 * * *'   # åŒ—äº¬æ—¶é—´ 13:00 (UTC+8)
  workflow_dispatch:

jobs:
  check-if-already-signed:
    runs-on: ubuntu-latest
    outputs:
      skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: æ¢å¤ç­¾åˆ°çŠ¶æ€ç¼“å­˜
        id: cache
        uses: actions/cache@v3
        with:
          path: .last_success_date
          key: ${{ runner.os }}-last-success-date-${{ github.ref }}
          restore-keys: ${{ runner.os }}-last-success-date-

      - name: æ£€æŸ¥æ˜¯å¦å·²ç­¾åˆ°
        id: check
        run: |
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "å½“å‰åŒ—äº¬æ—¶é—´: $current_date"
          
          # æ£€æŸ¥ç¼“å­˜æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f .last_success_date ]; then
            last_date=$(cat .last_success_date)
            echo "ä¸Šæ¬¡ç­¾åˆ°æ—¥æœŸ: $last_date"
            if [ "$last_date" = "$current_date" ]; then
              echo "âœ… ä»Šå¤©å·²æˆåŠŸç­¾åˆ°ï¼Œè·³è¿‡æ‰§è¡Œã€‚"
              echo "skip=true" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          
          echo "ğŸ“… ä»Šå¤©å°šæœªç­¾åˆ°ï¼Œç»§ç»­æ‰§è¡Œã€‚"
          echo "skip=false" >> "$GITHUB_OUTPUT"

  sign-in:
    needs: check-if-already-signed
    if: needs.check-if-already-signed.outputs.skip == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: éšæœºå»¶è¿Ÿï¼ˆæ—©ä¸Šï¼‰
        if: github.event.schedule == '0 1 * * *'
        run: |
          delay=$((RANDOM % 60))
          echo "â° æ—©ä¸Šç­¾åˆ°ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: éšæœºå»¶è¿Ÿï¼ˆä¸‹åˆ/æ‰‹åŠ¨è§¦å‘ï¼‰
        if: github.event.schedule == '0 5 * * *' || github.event_name == 'workflow_dispatch'
        run: |
          delay=$((RANDOM % 30))
          echo "â° ä¸‹åˆå…œåº•æˆ–æ‰‹åŠ¨è§¦å‘ï¼Œå»¶è¿Ÿ $delay ç§’åå¼€å§‹.."
          sleep $delay

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: å®‰è£…ä¾èµ–
        run: pip install requests

      - name: æ‰§è¡Œç­¾åˆ°è„šæœ¬ (å·²ä¼˜åŒ–)
        id: sign_script
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
          WPUSH_KEY: ${{ secrets.WPUSH_KEY }}
        run: |
          # ç¡®ä¿è„šæœ¬è¿”å›æ­£ç¡®é€€å‡ºç 
          python checkIn_Quark.py
          if [ $? -ne 0 ]; then
            echo "âŒ ç­¾åˆ°å¤±è´¥ï¼Œé€€å‡ºç : $?"
            exit 1
          fi

      - name: æ›´æ–°ç­¾åˆ°çŠ¶æ€ (ä»…æˆåŠŸæ—¶)
        if: success()
        run: |
          current_date=$(TZ='Asia/Shanghai' date '+%Y-%m-%d')
          echo "âœ… ç­¾åˆ°æˆåŠŸï¼Œæ›´æ–°ç¼“å­˜: $current_date"
          echo "$current_date" > .last_success_date

      - name: ä¿å­˜ç­¾åˆ°çŠ¶æ€ç¼“å­˜ (å…³é”®ä¿®å¤)
        if: success()
        uses: actions/cache@v3
        with:
          path: .last_success_date
          key: ${{ runner.os }}-last-success-date-${{ github.ref }}

      - name: ç¡®è®¤ç­¾åˆ°çŠ¶æ€ (è°ƒè¯•ç”¨)
        if: always()
        run: |
          echo "ç­¾åˆ°çŠ¶æ€: ${{ needs.check-if-already-signed.outputs.skip }}"
          echo "å½“å‰æ—¥æœŸ: $(TZ='Asia/Shanghai' date '+%Y-%m-%d')"
          echo "ç¼“å­˜æ–‡ä»¶å†…å®¹: $(cat .last_success_date 2>/dev/null || echo 'æ–‡ä»¶ä¸å­˜åœ¨')"
          echo "ç­¾åˆ°ç»“æœ: ${{ steps.sign_script.outcome }}"
