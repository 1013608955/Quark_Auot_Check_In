name: Quark签到

on:
  schedule:
    - cron: '0 1 * * *'   # 北京时间 09:00 (UTC+8)
    - cron: '0 5 * * *'   # 北京时间 13:00 (UTC+8)
  workflow_dispatch:

jobs:
  sign-in:
    permissions:
      actions: write  # 赋予缓存操作必要权限
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      # 第一步：恢复缓存（优先读取当日缓存，再读历史缓存）
      - name: 恢复签到状态缓存
        id: cache-restore
        uses: actions/cache/restore@v4
        with:
          path: .last_success_date
          # 核心修改：key加入当日日期，确保每天缓存唯一
          key: ${{ runner.os }}-quark-sign-${{ github.ref }}-${{ github.run_date }}
          # 降级读取：先读分支缓存，再读基础缓存
          restore-keys: |
            ${{ runner.os }}-quark-sign-${{ github.ref }}-
            ${{ runner.os }}-quark-sign-

      - name: 检查是否已签到
        id: check_sign
        run: |
          # 强制设置时区并验证
          export TZ='Asia/Shanghai'
          current_date=$(date '+%Y-%m-%d')
          echo "✅ 当前北京时间: $current_date"
          
          skip="false"
          # 检查缓存文件是否存在且日期匹配
          if [ -f .last_success_date ]; then
            last_date=$(cat .last_success_date)
            echo "✅ 缓存文件中的上次成功签到日期: $last_date"
            if [ "$last_date" = "$current_date" ]; then
              echo "✅ 今天已成功签到，跳过后续流程"
              skip="true"
            else
              echo "⚠️  缓存日期不匹配（上次：$last_date，当前：$current_date），继续执行"
            fi
          else
            echo "⚠️  未找到缓存文件，继续执行"
          fi
          
          echo "skip=$skip" >> "$GITHUB_OUTPUT"
          echo "current_date=$current_date" >> "$GITHUB_OUTPUT"

      - name: 随机延迟（仅未签到时执行）
        if: steps.check_sign.outputs.skip == 'false'
        run: |
          # 区分早上/下午延迟时间
          if [ "${{ github.event.schedule }}" = "0 1 * * *" ]; then
            delay=$((RANDOM % 60))
            echo "⏰ 早上签到，延迟 $delay 秒后开始.."
          else
            delay=$((RANDOM % 30))
            echo "⏰ 下午兜底/手动触发，延迟 $delay 秒后开始.."
          fi
          sleep $delay

      - name: 设置Python环境（仅未签到时执行）
        if: steps.check_sign.outputs.skip == 'false'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: 安装依赖（仅未签到时执行）
        if: steps.check_sign.outputs.skip == 'false'
        run: |
          pip install requests pytz
          pip list | grep -E "requests|pytz"  # 验证依赖安装

      - name: 执行签到脚本（仅未签到时执行）
        id: run_script
        if: steps.check_sign.outputs.skip == 'false'
        env:
          COOKIE_QUARK: ${{ secrets.COOKIE_QUARK }}
          WPUSH_KEY: ${{ secrets.WPUSH_KEY }}
        run: |
          # 执行脚本并捕获输出
          python checkIn_Quark.py
          # 读取脚本输出的 overall_success（关键：验证脚本是否认为全部成功）
          if [ -f "$GITHUB_OUTPUT" ]; then
            overall_success=$(grep "overall_success" "$GITHUB_OUTPUT" | cut -d'=' -f2)
            echo "✅ 脚本返回的签到状态: overall_success=$overall_success"
            echo "overall_success=$overall_success" >> "$GITHUB_OUTPUT"
          else
            echo "❌ 未找到脚本输出文件"
            echo "overall_success=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 验证缓存文件写入（仅未签到时执行）
        if: steps.check_sign.outputs.skip == 'false'
        run: |
          current_date=${{ steps.check_sign.outputs.current_date }}
          if [ -f .last_success_date ]; then
            written_date=$(cat .last_success_date)
            echo "✅ 缓存文件已写入，日期：$written_date"
            if [ "$written_date" = "$current_date" ]; then
              echo "✅ 写入日期与当前日期一致"
            else
              echo "❌ 写入日期异常（当前：$current_date，写入：$written_date）"
            fi
          else
            echo "❌ 脚本执行后未生成缓存文件（可能 overall_success 为 false）"
          fi

      - name: 确保缓存文件权限正确
        if: always()
        run: |
          if [ -f .last_success_date ]; then
            chmod 644 .last_success_date
            echo "✅ 缓存文件权限已设置"
          fi

      # 第二步：保存缓存（使用当日唯一key，避免冲突）
      - name: 保存签到状态缓存
        id: cache-save
        if: always()  # 无论前面步骤结果如何，都强制保存
        uses: actions/cache/save@v4
        with:
          path: .last_success_date
          # 核心修改：key加入当日日期，确保每天缓存唯一，避免冲突
          key: ${{ runner.os }}-quark-sign-${{ github.ref }}-${{ github.run_date }}

      # 可选：清理旧缓存（如需）
      #- name: 清理过期缓存
      #  uses: actions/github-script@v7
      #  with:
      #    script: |
      #      const cache = await github.rest.actions.getActionsCacheList({
      #        owner: context.repo.owner,
      #        repo: context.repo.repo,
      #      });
      #      const expiredCaches = cache.data.actions_caches.filter(c => 
      #        c.key.startsWith('${{ runner.os }}-quark-sign-') && 
      #        !c.key.includes('${{ github.run_date }}')
      #      );
      #      for (const c of expiredCaches) {
      #        await github.rest.actions.deleteActionsCacheById({
      #          owner: context.repo.owner,
      #          repo: context.repo.repo,
      #          cache_id: c.id
      #        });
      #      }
